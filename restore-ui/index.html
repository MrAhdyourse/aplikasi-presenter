<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LP3I System Restore Manager</title>
    <!-- Bootstrap 5 Dark Mode & FontAwesome -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0f172a;
            --card-bg: #1e293b;
            --accent: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
        }
        body {
            background-color: var(--bg-dark);
            color: #e2e8f0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .card {
            background-color: var(--card-bg);
            border: 1px solid #334155;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }
        .btn-primary { background-color: var(--accent); border: none; }
        .btn-primary:hover { background-color: #2563eb; }
        .snapshot-item {
            transition: all 0.2s;
            border-left: 4px solid transparent;
        }
        .snapshot-item:hover {
            background-color: #334155;
            border-left: 4px solid var(--accent);
            transform: translateX(5px);
        }
        .status-badge {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        .loader {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="loader" class="loader">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
        <h4 class="mt-3 text-white">Memproses System Restore...</h4>
        <p class="text-muted">Jangan tutup halaman ini.</p>
    </div>

    <div class="container py-5">
        <!-- Header -->
        <div class="row mb-5 align-items-center">
            <div class="col-md-8">
                <h1 class="fw-bold"><i class="fa-solid fa-screwdriver-wrench text-warning me-3"></i>System Restore Manager</h1>
                <p class="text-secondary mb-0">Emergency Recovery Tools untuk Proyek Aplikasi Presenter</p>
            </div>
            <div class="col-md-4 text-end">
                <div class="badge bg-success p-2 px-3 rounded-pill"><i class="fa-solid fa-circle-check me-2"></i>ENGINE ONLINE</div>
                <div class="text-secondary small mt-1">Port: 3001</div>
            </div>
        </div>

        <div class="row">
            <!-- Left Panel: Create Snapshot -->
            <div class="col-md-5 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-transparent border-bottom border-secondary py-3">
                        <h5 class="mb-0"><i class="fa-solid fa-camera me-2 text-info"></i>Buat Checkpoint Baru</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info border-0 bg-opacity-10 bg-info text-info small">
                            <i class="fa-solid fa-circle-info me-2"></i>
                            Buat checkpoint sebelum melakukan perubahan besar pada kode. Ini akan menyimpan seluruh kondisi file saat ini.
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-secondary small text-uppercase fw-bold">Pesan / Label</label>
                            <input type="text" id="snapshotMsg" class="form-control bg-dark text-white border-secondary" placeholder="Contoh: Sebelum install plugin baru...">
                        </div>
                        <button onclick="createSnapshot()" class="btn btn-primary w-100 py-2 fw-bold">
                            <i class="fa-solid fa-save me-2"></i>SIMPAN KONDISI SEKARANG
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Panel: History & Restore -->
            <div class="col-md-7">
                <div class="card h-100">
                    <div class="card-header bg-transparent border-bottom border-secondary py-3 d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fa-solid fa-history me-2 text-warning"></i>Riwayat Restore Point</h5>
                        <button onclick="loadSnapshots()" class="btn btn-sm btn-outline-secondary"><i class="fa-solid fa-sync"></i> Refresh</button>
                    </div>
                    <div class="card-body p-0">
                        <div id="snapshotList" class="list-group list-group-flush">
                            <!-- List will be injected here -->
                            <div class="text-center py-5 text-muted">
                                <div class="spinner-border spinner-border-sm mb-2" role="status"></div>
                                <p>Memuat data...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="text-center mt-5 text-secondary small">
            &copy; 2026 LP3I Developer Team - Local Development Tools
        </div>
    </div>

    <!-- Script Logic -->
    <script>
        const API_URL = '/api';

        async function loadSnapshots() {
            const list = document.getElementById('snapshotList');
            try {
                const res = await fetch(`${API_URL}/snapshots`);
                const data = await res.json();
                
                if(data.data.length === 0) {
                    list.innerHTML = '<div class="text-center py-5 text-muted">Belum ada Restore Point tersimpan.</div>';
                    return;
                }

                let html = '';
                data.data.forEach(snap => {
                    html += `
                        <div class="list-group-item bg-transparent text-light border-secondary p-3 snapshot-item d-flex justify-content-between align-items-center">
                            <div>
                                <div class="d-flex align-items-center gap-2 mb-1">
                                    <span class="badge bg-secondary mono text-light">${snap.id}</span>
                                    <small class="text-muted"><i class="fa-regular fa-clock me-1"></i>${new Date().toLocaleDateString()}</small>
                                </div>
                                <div class="fw-bold">${snap.name}</div>
                            </div>
                            <button onclick="restore('${snap.id}')" class="btn btn-sm btn-outline-danger px-3">
                                <i class="fa-solid fa-rotate-left me-1"></i> RESTORE
                            </button>
                        </div>
                    `;
                });
                list.innerHTML = html;
            } catch (error) {
                list.innerHTML = '<div class="text-center py-5 text-danger">Gagal terhubung ke Server Engine.</div>';
            }
        }

        async function createSnapshot() {
            const msgInput = document.getElementById('snapshotMsg');
            const message = msgInput.value.trim();
            if(!message) { alert("Wajib isi pesan label!"); return; }

            showLoader(true);
            try {
                const res = await fetch(`${API_URL}/snapshot`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ message })
                });
                const data = await res.json();
                if(data.success) {
                    msgInput.value = '';
                    loadSnapshots();
                    alert("Berhasil! Checkpoint tersimpan.");
                } else {
                    alert("Error: " + data.error);
                }
            } catch(e) {
                alert("Gagal koneksi server.");
            } finally {
                showLoader(false);
            }
        }

        async function restore(tagId) {
            if(!confirm("BAHAYA! PERINGATAN KERAS!\n\nAnda akan mengembalikan SELURUH file proyek ke titik: " + tagId + ".\n\nSemua perubahan yang belum disimpan setelah titik itu akan HILANG SELAMANYA.\n\nYakin ingin melanjutkan?")) return;

            showLoader(true);
            try {
                const res = await fetch(`${API_URL}/restore`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ tagId })
                });
                const data = await res.json();
                if(data.success) {
                    alert("SUKSES! Sistem telah dikembalikan ke " + tagId + ".\nSilakan restart server development (npm run dev) jika diperlukan.");
                } else {
                    alert("Gagal Restore: " + data.error);
                }
            } catch(e) {
                alert("Fatal Error saat restore.");
            } finally {
                showLoader(false);
            }
        }

        function showLoader(show) {
            document.getElementById('loader').style.display = show ? 'flex' : 'none';
        }

        // Init load
        loadSnapshots();
    </script>
</body>
</html>
